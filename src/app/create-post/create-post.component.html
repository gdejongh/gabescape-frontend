<div class="create-post-page">
  <div class="page-header">
    <a routerLink="/" class="back-link">← Back to feed</a>
    <h1 class="page-title">Create a Post</h1>
  </div>

  <form class="create-form card" (ngSubmit)="onSubmit()">
    <div *ngIf="error" class="form-error">
      {{ error }}
    </div>

    <div class="form-group">
      <label class="form-label">SubScape</label>
      <div class="subscape-autocomplete">
        <div *ngIf="selectedSubScape" class="subscape-selected">
          <span class="selected-name">{{ selectedSubScape.subScapeName }}</span>
          <span class="selected-desc" *ngIf="selectedSubScape.subScapeDescription"> — {{ selectedSubScape.subScapeDescription }}</span>
          <button type="button" class="clear-btn" (click)="clearSelection()" [disabled]="submitting">&times;</button>
        </div>
        <input
          *ngIf="!selectedSubScape"
          type="text"
          class="input"
          placeholder="Search for a SubScape…"
          [(ngModel)]="searchTerm"
          name="searchTerm"
          (focus)="onSearchFocus()"
          (blur)="onSearchBlur()"
          [disabled]="submitting || loadingSubScapes"
          autocomplete="off"
        />
        <ul class="subscape-dropdown" *ngIf="showDropdown && !selectedSubScape && filteredSubScapes.length > 0">
          <li
            *ngFor="let s of filteredSubScapes"
            class="subscape-option"
            (mousedown)="selectSubScape(s)"
          >
            <span class="option-name">{{ s.subScapeName }}</span>
            <span class="option-desc" *ngIf="s.subScapeDescription"> — {{ s.subScapeDescription }}</span>
          </li>
        </ul>
        <div class="subscape-dropdown subscape-empty-container" *ngIf="showDropdown && !selectedSubScape && filteredSubScapes.length === 0 && !loadingSubScapes">
          <div *ngIf="!showInlineCreate" class="create-new-option" (mousedown)="startInlineCreate()">
            <span class="create-new-icon">+</span>
            <span class="create-new-text">
              <span class="create-new-label">Create new SubScape</span>
              <span class="create-new-hint" *ngIf="searchTerm.trim()">"{{ searchTerm.trim() }}"</span>
            </span>
          </div>
          <div *ngIf="showInlineCreate" class="inline-create-form">
            <div class="inline-create-header">
              <span class="inline-create-title">◈ New SubScape</span>
              <button type="button" class="inline-cancel-x" (mousedown)="cancelInlineCreate()">✕</button>
            </div>
            <div *ngIf="createSubError" class="inline-error">{{ createSubError }}</div>
            <div class="inline-field">
              <label class="inline-label">Name</label>
              <input
                type="text"
                class="input input-sm"
                placeholder="e.g. Gaming, Science…"
                [(ngModel)]="newSubScapeName"
                name="newSubScapeName"
                [disabled]="creatingSub"
                autocomplete="off"
              />
            </div>
            <div class="inline-field">
              <label class="inline-label">Description <span class="inline-opt">(optional)</span></label>
              <textarea
                class="textarea textarea-sm"
                placeholder="What is this SubScape about?"
                [(ngModel)]="newSubScapeDesc"
                name="newSubScapeDesc"
                rows="2"
                [disabled]="creatingSub"
              ></textarea>
            </div>
            <div class="inline-actions">
              <button type="button" class="btn btn-sm" (mousedown)="cancelInlineCreate()" [disabled]="creatingSub">Cancel</button>
              <button type="button" class="btn btn-accent btn-sm" (mousedown)="submitInlineSubScape()" [disabled]="creatingSub">
                {{ creatingSub ? 'Creating…' : 'Create SubScape' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="title">Title</label>
      <input
        id="title"
        type="text"
        class="input"
        placeholder="An interesting title..."
        [(ngModel)]="title"
        name="title"
        [disabled]="submitting"
      />
    </div>

    <div class="form-group">
      <label class="form-label" for="text">Body</label>
      <textarea
        id="text"
        class="textarea"
        placeholder="What's on your mind?"
        [(ngModel)]="text"
        name="text"
        rows="6"
        [disabled]="submitting"
      ></textarea>
    </div>

    <div class="form-actions">
      <a routerLink="/" class="btn">Cancel</a>
      <button type="submit" class="btn btn-accent" [disabled]="submitting">
        {{ submitting ? 'Posting...' : 'Create Post' }}
      </button>
    </div>
  </form>
</div>
